<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    .status-badge {
      font-size: 0.85em;
      padding: 0.25em 0.5em;
      border-radius: 0.25rem;
      margin-left: 8px;
      vertical-align: middle;
    }
    .status-in_review { background-color: #ffc107; color: #212529; }
    .status-approved { background-color: #28a745; color: white; }
    .status-rejected { background-color: #dc3545; color: white; }
    .review-block {
      background-color: #f8d7da;
      border-left: 4px solid #dc3545;
      padding: 0.75rem;
      margin-top: 0.75rem;
      font-size: 0.95em;
      border-radius: 0.25rem;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</h1>

    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <div id="login-section" class="card p-4 mb-4">
      <h3>–í—Ö–æ–¥</h3>
      <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è</p>
      <form id="login-form">
        <div class="mb-3">
          <input type="text" id="teacher-id" class="form-control" placeholder="ID –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: T-MATH-01)" required>
        </div>
        <div class="mb-3">
          <input type="password" id="password" class="form-control" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–î–î.–ú–ú.–ì–ì–ì–ì)" required>
        </div>
        <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
      </form>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="main-section" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="teacher-name"></span>!</h2>
        <button id="logout-btn" class="btn btn-outline-secondary">–í—ã–π—Ç–∏</button>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
      <div class="d-flex justify-content-between mb-3">
        <h3>–†–∞–±–æ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>
        <button id="show-history-btn" class="btn btn-outline-info">üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞—á—Ç—ë–Ω–Ω—ã—Ö</button>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>–°—Ç—É–¥–µ–Ω—Ç</th>
              <th>–ü—Ä–µ–¥–º–µ—Ç</th>
              <th>–ó–∞–¥–∞–Ω–∏–µ</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–∞—Ç–∞ –¥–µ–π—Å—Ç–≤–∏—è</th>
              <th>–§–∞–π–ª—ã</th>
              <th>–û—Ü–µ–Ω–∫–∞</th>
            </tr>
          </thead>
          <tbody id="submissions"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
  <div class="modal fade" id="gradeModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="grade-form">
            <input type="hidden" id="modal-student-id">
            <input type="hidden" id="modal-subject-name">
            <input type="hidden" id="modal-assignment-id">
            
            <div class="mb-3">
              <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
              <select class="form-select" id="status-input" required>
                <option value="–ø—Ä–∏–Ω—è—Ç –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ">–ü—Ä–∏–Ω—è—Ç –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ</option>
                <option value="–∑–∞—á—ë—Ç">–ó–∞—á—ë—Ç</option>
                <option value="–Ω–µ –∑–∞—á—Ç–µ–Ω–æ">–ù–µ –∑–∞—á—Ç–µ–Ω–æ</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">–†–µ—Ü–µ–Ω–∑–∏—è (–µ—Å–ª–∏ –Ω–µ –∑–∞—á—Ç–µ–Ω–æ)</label>
              <textarea class="form-control" id="review" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ñ–∞–π–ª—ã -->
  <div class="modal fade" id="filesModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–§–∞–π–ª—ã —Ä–∞–±–æ—Ç—ã</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="files-list">
          <!-- –°—é–¥–∞ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã -->
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –∏—Å—Ç–æ—Ä–∏—è -->
  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞—á—Ç—ë–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                  <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                  <th>–ó–∞–¥–∞–Ω–∏–µ</th>
                  <th>–î–∞—Ç–∞ –∑–∞—á—ë—Ç–∞</th>
                </tr>
              </thead>
              <tbody id="history-rows"></tbody>
            </table>
          </div>
          <p class="text-muted text-center" id="history-empty" style="display:none;">–ù–µ—Ç –∑–∞—á—Ç—ë–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å —Ç–æ–∫–µ–Ω–æ–º
    function getAuthHeaders() {
      const token = localStorage.getItem('auth_token');
      return token ? { 'Authorization': `Bearer ${token}` } : {};
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('auth_token');
      const teacherName = localStorage.getItem('teacher_name');
      if (token && teacherName) {
        document.getElementById('teacher-name').textContent = teacherName;
        loadSubmissions();
        showMain();
      } else {
        showLogin();
      }
    });

    function showLogin() {
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('main-section').style.display = 'none';
    }

    function showMain() {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('main-section').style.display = 'block';
    }

    // –í—Ö–æ–¥
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const teacherId = document.getElementById('teacher-id').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!teacherId || !password) return;

      try {
        const res = await fetch('/api/teacher/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `teacher_id=${encodeURIComponent(teacherId)}&password=${encodeURIComponent(password)}`
        });
        if (!res.ok) {
          const error = await res.json().catch(() => ({detail: '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'}));
          throw new Error(error.detail || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
        }
        const data = await res.json();
        localStorage.setItem('auth_token', data.token);
        localStorage.setItem('teacher_name', 
          `${data.user.last_name} ${data.user.first_name}${data.user.patronymic ? ' ' + data.user.patronymic : ''}`
        );
        document.getElementById('teacher-name').textContent = 
          `${data.user.last_name} ${data.user.first_name}${data.user.patronymic ? ' ' + data.user.patronymic : ''}`;
        loadSubmissions();
        showMain();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    });

    // –í—ã—Ö–æ–¥
    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('teacher_name');
      showLogin();
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç (—Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)
    async function loadSubmissions() {
      try {
        const res = await fetch(`/api/teacher/assignments/me`, {
          headers: getAuthHeaders()
        });
        if (!res.ok) throw new Error('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞');
        const submissions = await res.json();
        const tbody = document.getElementById('submissions');
        tbody.innerHTML = '';

        submissions.forEach(row => {
          let statusBadge = '';
          if (row.last_status) {
            const statusMap = {
              '–ø—Ä–∏–Ω—è—Ç –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ': 'in_review',
              '–∑–∞—á—ë—Ç': 'approved',
              '–Ω–µ –∑–∞—á—Ç–µ–Ω–æ': 'rejected'
            };
            const cls = statusMap[row.last_status] || '';
            statusBadge = `<span class="status-badge status-${cls}">${row.last_status}</span>`;
          }

          let lastAction = '‚Äî';
          if (row.last_action_at) {
            lastAction = new Date(row.last_action_at).toLocaleString('ru-RU');
          } else if (row.submitted_at) {
            lastAction = new Date(row.submitted_at).toLocaleString('ru-RU') + ' (–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞)';
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.student_name}<br><small>${row.student_id}</small></td>
            <td>${row.subject}</td>
            <td>${row.title}<br><small>–î–µ–¥–ª–∞–π–Ω: ${new Date(row.deadline).toLocaleDateString('ru-RU')}</small></td>
            <td>${statusBadge || row.last_status || '‚Äî'}</td>
            <td>${lastAction}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary view-files" 
                      data-assignment-id="${row.assignment_id}" 
                      data-student-id="${row.student_id}">
                üìé –§–∞–π–ª—ã
              </button>
            </td>
            <td>
              <button class="btn btn-sm btn-outline-success set-grade"
                      data-student-id="${row.student_id}"
                      data-subject-name="${row.subject}"
                      data-assignment-id="${row.assignment_id}">
                ‚úèÔ∏è –°—Ç–∞—Ç—É—Å
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.view-files').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const assignmentId = e.target.dataset.assignmentId;
            const studentId = e.target.dataset.studentId;
            const res = await fetch(`/api/teacher/files/${assignmentId}/${studentId}`, {
              headers: getAuthHeaders()
            });
            const files = await res.json();
            
            const filesList = document.getElementById('files-list');
            filesList.innerHTML = '';
            
            if (files.length === 0) {
              filesList.innerHTML = '<p class="text-muted">–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
            } else {
              files.forEach(f => {
                const link = document.createElement('div');
                link.innerHTML = `
                  <a href="/download/${f.path}" target="_blank" class="btn btn-sm btn-outline-secondary w-100 mb-2">
                    üìé ${f.name}
                  </a>
                `;
                filesList.appendChild(link);
              });
            }
            
            bootstrap.Modal.getOrCreateInstance(document.getElementById('filesModal')).show();
          });
        });

        document.querySelectorAll('.set-grade').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const modal = document.getElementById('gradeModal');
            document.getElementById('modal-student-id').value = e.target.dataset.studentId;
            document.getElementById('modal-subject-name').value = e.target.dataset.subjectName;
            document.getElementById('modal-assignment-id').value = e.target.dataset.assignmentId;
            document.getElementById('review').value = '';
            bootstrap.Modal.getOrCreateInstance(modal).show();
          });
        });
      } catch (err) {
        alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥');
        localStorage.removeItem('auth_token');
        showLogin();
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞—á—Ç—ë–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç
    async function loadHistory() {
      try {
        const res = await fetch(`/api/teacher/history/me`, {
          headers: getAuthHeaders()
        });
        if (!res.ok) throw new Error('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞');
        const history = await res.json();
        const tbody = document.getElementById('history-rows');
        const emptyMsg = document.getElementById('history-empty');
        
        tbody.innerHTML = '';
        if (history.length === 0) {
          emptyMsg.style.display = 'block';
        } else {
          emptyMsg.style.display = 'none';
          history.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${item.student_name}<br><small>${item.student_id}</small></td>
              <td>${item.subject}</td>
              <td>${item.assignment_title}</td>
              <td>
                ${new Date(item.graded_at).toLocaleString('ru-RU')}
                <br>
                <button class="btn btn-sm btn-outline-primary mt-1 history-view-files"
                        data-assignment-id="${item.assignment_id}"
                        data-student-id="${item.student_id}">
                  üìé –§–∞–π–ª—ã
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–§–∞–π–ª—ã" –≤ –∏—Å—Ç–æ—Ä–∏–∏
          document.querySelectorAll('.history-view-files').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const assignmentId = e.target.dataset.assignmentId;
              const studentId = e.target.dataset.studentId;
              const res = await fetch(`/api/teacher/files/${assignmentId}/${studentId}`, {
                headers: getAuthHeaders()
              });
              const files = await res.json();
              
              const filesList = document.getElementById('files-list');
              filesList.innerHTML = '';
              
              if (files.length === 0) {
                filesList.innerHTML = '<p class="text-muted">–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
              } else {
                files.forEach(f => {
                  const link = document.createElement('div');
                  link.innerHTML = `
                    <a href="/download/${f.path}" target="_blank" class="btn btn-sm btn-outline-secondary w-100 mb-2">
                      üìé ${f.name}
                    </a>
                  `;
                  filesList.appendChild(link);
                });
              }
              
              bootstrap.Modal.getOrCreateInstance(document.getElementById('filesModal')).show();
            });
          });
        }

        bootstrap.Modal.getOrCreateInstance(document.getElementById('historyModal')).show();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + err.message);
      }
    }

    // –ö–Ω–æ–ø–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è"
    document.getElementById('show-history-btn').addEventListener('click', loadHistory);

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
    document.getElementById('grade-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentId = document.getElementById('modal-student-id').value;
      const subjectName = document.getElementById('modal-subject-name').value;
      const assignmentId = document.getElementById('modal-assignment-id').value;
      const statusInput = document.getElementById('status-input').value;
      const review = document.getElementById('review').value;

      const res = await fetch('/api/teacher/grade', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/x-www-form-urlencoded',
          ...getAuthHeaders()
        },
        body: new URLSearchParams({
          student_id: studentId,
          subject_name: subjectName,
          assignment_id: assignmentId,
          status_input: statusInput,
          review: review
        })
      });

      if (res.ok) {
        alert('–°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        bootstrap.Modal.getInstance(document.getElementById('gradeModal')).hide();
        loadSubmissions();
      } else {
        const error = await res.json().catch(() => ({detail: '–û—à–∏–±–∫–∞'}));
        alert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    });
  </script>
</body>
</html>